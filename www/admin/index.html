<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n</title>
  <link href="/static/style.css" rel="stylesheet" type="text/css">
  <link href="/admin/style.css" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="icon" href="/static/favicon.png" type="image/png" />
</head>

<body>

  <div class="nav-bar">
    <a class="nav-item" id="ficha-link" href="/ficha">FICHA</a>
    <a class="nav-item" id="conexiones-link" href="/conexiones" style="display:none;">CONEXIONES</a>
    <a class="nav-item" id="poderes-link" href="/poderes">PODERES</a>
  
    <div id="admin-link-container" style="display:none;">
      <a class="nav-item active" href="/admin">ADMIN</a>
    </div>
  
    <div class="nav-item dropdown" id="ia-dropdown-container" style="display:none;">
      IAs
      <div class="dropdown-content" id="ia-dropdown">
        <!-- Links din√°micos a IAs -->
      </div>
    </div>
  </div>

  <!-- Modal para editar poderes por personaje (nivel superior) -->
  <div id="poderes-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Editar Poderes por Personaje</h2>

      <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
        <select id="lista-usuarios-poderes" style="flex:1;"></select>
        <input id="nuevo-usuario-poderes" placeholder="Crear nuevo usuario" />
        <button id="cargar-poderes-usuario">Cargar</button>
      </div>

      <textarea id="editor-poderes" style="width:100%; height:300px; font-family:monospace;"></textarea>

      <div class="modal-buttons" style="margin-top:8px;">
        <button id="guardar-poderes">Guardar</button>
        <button id="eliminar-poderes" style="background:#ff6b35; color:white;">Eliminar Archivo</button>
        <button id="cerrar-poderes">Cerrar</button>
      </div>
    </div>
  </div>
  
  <script>
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const sessionRes = await fetch("/session-info");
        const sessionData = await sessionRes.json();
        const id = sessionData.usuario;
        const rol = sessionData.rol;
  
        if (id) {
          document.getElementById("conexiones-link").setAttribute("href", `/conexiones`);
  
          if (rol === "admin") {
            document.getElementById("admin-link-container").style.display = "inline-block";
          }
  
          const usosRes = await fetch("/usos");
          if (usosRes.ok) {
            const usos = await usosRes.json();
            const iaDropdown = document.getElementById("ia-dropdown");
            const iaDropdownContainer = document.getElementById("ia-dropdown-container");
  
            const ias = ["hada", "eidolon", "fantasma", "anima"];
            let tieneIAsDisponibles = false;
  
              ias.forEach(ia => {
              const cantidad = usos[ia];
              if (cantidad === -1 || (typeof cantidad === "number" && cantidad >= 0)) {
                const link = document.createElement("a");
                link.href = `/${ia}`;
                link.textContent = ia.charAt(0).toUpperCase() + ia.slice(1);
                iaDropdown.appendChild(link);
                tieneIAsDisponibles = true;
              }
            });
  
            if (tieneIAsDisponibles) {
              iaDropdownContainer.style.display = "inline-block";
            }
          }
        }
  
        // Dropdown toggle al hacer clic
        const dropdown = document.getElementById("ia-dropdown-container");
        const dropdownContent = document.getElementById("ia-dropdown");
  
        if (dropdown && dropdownContent) {
          dropdown.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("active");
          });
  
          document.addEventListener("click", (e) => {
            if (!dropdown.contains(e.target)) {
              dropdown.classList.remove("active");
            }
          });
  
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              dropdown.classList.remove("active");
            }
          });
        }
  
      } catch (error) {
        console.error("Error cargando sesi√≥n o usos:", error);
      }
    });
  </script>

  <div class="admin-container">
    <h1>Panel de Administraci√≥n</h1>

    <section class="admin-section">
      <h2>Gesti√≥n de Personajes</h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
        <button id="ver-personajes">Ver Personajes</button>
        <button id="actualizar-contadores" title="Recargar contadores desde el servidor (descarta ediciones no guardadas)">Actualizar contadores</button>
        <button id="crear-personaje">A√±adir Personaje</button>
      </div>
      <div id="lista-personajes" style="display: none;"></div>
    </section>

    <section class="admin-section">
      <h2>Gesti√≥n del Sistema</h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
        <button id="limpiar-cache" style="background: #ff6b35; color: white;">üßπ Limpiar Cach√©</button>
        <button id="ver-estado-sistema" style="background: #4ecdc4; color: white;">üìä Estado del Sistema</button>
        <button id="download-logs" style="background: #007bff; color: white;">üì¶ Descargar Logs</button>
      </div>
      <div id="estado-sistema" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 10px;"></div>
    </section>

  </div>

  <!-- Modal para Crear/Editar Personaje -->
  <div id="personaje-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2 id="modal-title">Crear Personaje</h2>
      <input type="text" id="nombre-input" placeholder="Nombre" />
      <input type="password" id="clave-input" placeholder="Clave" />
      <select id="rol-input">
        <option value="jugador">Jugador</option>
        <option value="admin">Admin</option>
      </select>
      <div class="modal-buttons">
        <button id="guardar-personaje">Guardar</button>
        <button id="cancelar-personaje">Cancelar</button>
      </div>
    </div>

      <!-- poderes-modal moved outside personaje-modal -->
  </div>

  <!-- Modal de Log -->
  <div id="modal-log" class="modal" style="display: none;">
    <div class="modal-content-log">
      <span id="cerrar-modal-log" style="cursor: pointer; float: right;">‚úñ</span>
      <h2 id="titulo-log" style="margin-top: 0;">Historial de Personaje</h2>
      <div id="contenido-log" style="max-height: 400px; overflow-y: auto; margin-top: 10px;"></div>
    </div>
  </div>

  <!-- Modal de Conexiones -->
  <!-- Modal de Conexiones -->
  <div id="conexiones-modal" class="modal" style="display: none;">
    <div class="modal-content-log">
      <span id="cerrar-modal-conexiones" style="cursor: pointer; float: right;">‚úñ</span>
      <h2 id="titulo-conexiones" style="margin-top: 0;">Conexiones de [Personaje]</h2>

      <!-- üöÄ A√ëADIR NUEVO NODO MANUAL -->
      <div style="margin-bottom: 20px;">
        <h3>A√±adir nuevo nodo</h3>
        <input type="text" id="nuevo-nodo-id" placeholder="ID del nodo" style="margin-right: 6px; margin-bottom: 6px;">
        <input type="text" id="nuevo-nodo-label" placeholder="Nombre visible"
          style="margin-right: 6px; margin-bottom: 6px;">
        <button id="crear-nodo">Crear Nodo</button>
      </div>

      <!-- üöÄ A√ëADIR NUEVA CONEXI√ìN -->
      <div style="margin-bottom: 20px;">
        <h3>A√±adir nueva conexi√≥n</h3>
        <select id="source-nodo" style="margin-right: 6px;"></select>
        <select id="target-nodo" style="margin-right: 6px;"></select>
        <input type="text" id="label-conexion" placeholder="Descripci√≥n de la conexi√≥n" style="margin-right: 6px;">
        <button id="a√±adir-conexion">A√±adir Conexi√≥n</button>
      </div>

      <!-- üöÄ LISTADO CONEXIONES -->
      <div id="lista-conexiones" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>

      <h3 style="margin-top: 20px;">Nodos Existentes</h3>
      <div id="lista-nodos" style="max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>



      <!-- üöÄ BOT√ìN GUARDAR -->
      <div style="margin-top: 20px; text-align: center;">
        <button id="guardar-conexiones">Guardar Cambios</button>
      </div>
    </div>
    <div id="cy-mini"
      style="width: 30%; height: 500px;border: 1px solid #00ffff55; background: #111; margin-top: 20px;"></div>
  </div>

  <div id="modal-ficha" class="modal" style="display: none;">
    <div class="modal-content esquema-ficha">
      <h2 id="titulo-ficha">Ficha de Personaje</h2>
  
      <!-- ENCABEZADO -->
      <div class="bloque encabezado">
        <div class="campo">
          <label>Nombre de Personaje</label>
          <input type="text" data-id="nombre_personaje">
        </div>
        <div class="campo">
          <label>Nombre del Jugador</label>
          <input type="text" data-id="nombre_jugador">
        </div>
      </div>
  
      <!-- EIDOS -->
      <div class="bloque titulo-seccion">Eidos</div>
      <div class="bloque fila-eidos">
        <div class="campo"><label>C√°bala</label><input type="text" data-id="cabala"></div>
        <div class="campo"><label>Naturaleza</label><input type="text" data-id="naturaleza"></div>
        <div class="campo"><label>Senda</label><input type="text" data-id="senda"></div>
        <div class="campo"><label>Arquetipo</label><input type="text" data-id="arquetipo"></div>
      </div>
      <div class="bloque fila-eidos">
        <div class="campo"><label>Arquetipo secundario</label><input type="text" data-id="sec_1"></div>
        <div class="campo"><label>Arquetipo secundario</label><input type="text" data-id="sec_2"></div>
        <div class="campo"><label>Arquetipo secundario</label><input type="text" data-id="sec_3"></div>
        <div class="campo"><label>Arquetipo secundario</label><input type="text" data-id="sec_4"></div>
      </div>
  
      <!-- VIDA -->
      <div class="bloque titulo-seccion">Vida</div>
      <div class="bloque fila-vida">
        <div class="campo"><label>Da√±o</label><input type="number" min="0" max="3" data-id="da√±o"></div>
        <div class="campo"><label>Rotura</label><input type="number" min="0" max="3" data-id="rotura"></div>
      </div>
  
      <!-- CHIMERA -->
      <div class="bloque titulo-seccion">Chimera</div>
      <div class="bloque fila-chimera">
        <div class="campo"><label>Mutaci√≥n Arcana</label><input type="number" min="0" max="3" data-id="mutacion"></div>
        <div class="campo"><label>Cyber-Infecci√≥n</label><input type="number" min="0" max="3" data-id="cyber"></div>
      </div>
  
      <div class="modal-actions">
        <button id="guardar-ficha">Guardar</button>
        <button id="cerrar-modal-ficha">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="/admin/admin.js"></script> <!-- Este es tu JavaScript de gesti√≥n -->
</body>

</html>