version: "3.8"

services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  web:
    build: .
    container_name: chatbotuvo
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "5000:5000"
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Si tu app está en www/app.py con "app" como objeto Flask:
      - APP_MODULE=www.app:app
      # Opcional: controla concurrencia del web (no afecta al worker RQ):
      - WEB_CONCURRENCY=6
      - THREADS=16
      - TIMEOUT=120
    volumes:
      # Datos persistentes externos al repo
      - ./data/state:/state
      - ./data/personajes.json:/app/www/personajes.json
      - ./data/logs:/app/www/admin/logs
      - ./data/ficha/personajes:/app/www/ficha/personajes
      - ./data/tramas/personajes:/app/www/tramas/personajes
      - ./data/notas/usuarios:/app/www/poderes/usuarios
      - ./data/historiales:/app/www/historiales
      # Datos estáticos del repo
      - ./MinervaPrimeSE/data:/app/MinervaPrimeSE/data
      - ./pdfs:/app/pdfs
      - ./personalidades:/app/personalidades
    # Si tu Dockerfile ya hace CMD ["/app/entrypoint.sh"], no hace falta command aquí.

  worker-1:
    build: .
    container_name: chatbotuvo-worker-1
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data/state:/state
      - ./data/personajes.json:/app/www/personajes.json
      - ./data/logs:/app/www/admin/logs
      - ./data/ficha/personajes:/app/www/ficha/personajes
      - ./data/tramas/personajes:/app/www/tramas/personajes
      - ./data/notas/usuarios:/app/www/poderes/usuarios
      - ./data/historiales:/app/www/historiales
      - ./MinervaPrimeSE/data:/app/MinervaPrimeSE/data
      - ./pdfs:/app/pdfs
      - ./personalidades:/app/personalidades
    command: ["python", "-m", "MinervaPrimeNSE.worker"]

  worker-2:
    build: .
    container_name: chatbotuvo-worker-2
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data/state:/state
      - ./data/personajes.json:/app/www/personajes.json
      - ./data/logs:/app/www/admin/logs
      - ./data/ficha/personajes:/app/www/ficha/personajes
      - ./data/tramas/personajes:/app/www/tramas/personajes
      - ./data/notas/usuarios:/app/www/poderes/usuarios
      - ./data/historiales:/app/www/historiales
      - ./MinervaPrimeSE/data:/app/MinervaPrimeSE/data
      - ./pdfs:/app/pdfs
      - ./personalidades:/app/personalidades
    command: ["python", "-m", "MinervaPrimeNSE.worker"]

  worker-3:
    build: .
    container_name: chatbotuvo-worker-3
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data/state:/state
      - ./data/personajes.json:/app/www/personajes.json
      - ./data/logs:/app/www/admin/logs
      - ./data/ficha/personajes:/app/www/ficha/personajes
      - ./data/tramas/personajes:/app/www/tramas/personajes
      - ./data/notas/usuarios:/app/www/poderes/usuarios
      - ./data/historiales:/app/www/historiales
      - ./MinervaPrimeSE/data:/app/MinervaPrimeSE/data
      - ./pdfs:/app/pdfs
      - ./personalidades:/app/personalidades
    command: ["python", "-m", "MinervaPrimeNSE.worker"]

  worker-4:
    build: .
    container_name: chatbotuvo-worker-4
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data/state:/state
      - ./data/personajes.json:/app/www/personajes.json
      - ./data/logs:/app/www/admin/logs
      - ./data/ficha/personajes:/app/www/ficha/personajes
      - ./data/tramas/personajes:/app/www/tramas/personajes
      - ./data/notas/usuarios:/app/www/poderes/usuarios
      - ./data/historiales:/app/www/historiales
      - ./MinervaPrimeSE/data:/app/MinervaPrimeSE/data
      - ./pdfs:/app/pdfs
      - ./personalidades:/app/personalidades
    command: ["python", "-m", "MinervaPrimeNSE.worker"]

  worker-5:
    build: .
    container_name: chatbotuvo-worker-5
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data/state:/state
      - ./data/personajes.json:/app/www/personajes.json
      - ./data/logs:/app/www/admin/logs
      - ./data/ficha/personajes:/app/www/ficha/personajes
      - ./data/tramas/personajes:/app/www/tramas/personajes
      - ./data/notas/usuarios:/app/www/poderes/usuarios
      - ./data/historiales:/app/www/historiales
      - ./MinervaPrimeSE/data:/app/MinervaPrimeSE/data
      - ./pdfs:/app/pdfs
      - ./personalidades:/app/personalidades
    command: ["python", "-m", "MinervaPrimeNSE.worker"]